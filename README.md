# aws-credential-tracker

## Description
Leverages the AWS credentials report along with a few AWS services to run scheduled bulk checks against users in an AWS account allowing IAM credentials, access keys and certificates to be audited and automatically disabled according to the credential lifecycle policy that you define.

## Architecture
![alt text][arch-image]

## Component Breakdown

### Identity and Access Management (IAM)
AWS IAM is used to securely control individual and group access to your AWS resources. You can create and manage user identities ("IAM users") and grant permissions for those IAM users to access your resources. You can also grant permissions for users outside of AWS.

The credential tracker is executed under the credentials tracker execution role.  An IAM role is an IAM entity that defines a set of permissions for making AWS service requests. IAM roles are not associated with a specific user or group. Instead, trusted entities assume roles, such as IAM users, applications, or AWS services such as EC2.

#### Permissions
The credentials tracker role has both an [execution permissions policy] and an [assume role policy].

#### Credential Report
The IAM credential reports can be used to assist in your auditing and compliance efforts. You can use the report to audit the effects of credential lifecycle requirements, such as password and access key rotation. You can provide the report to an external auditor, or grant permissions to an auditor so that he or she can download the report directly.

You can generate a credential report as often as once every four hours. When you request a report, IAM first checks whether a report for the AWS account has been generated within the past four hours. If so, the most recent report is downloaded. If the most recent report for the account is older than four hours, or if there are no previous reports for the account, IAM generates and downloads a new report.

### CloudWatch
Amazon CloudWatch is a monitoring service for AWS cloud resources and the applications you run on AWS. You can use Amazon CloudWatch to collect and track metrics, collect and monitor log files, and set alarms. Amazon CloudWatch can monitor AWS resources such as Amazon EC2 instances, Amazon DynamoDB tables, and Amazon RDS DB instances, as well as custom metrics generated by your applications and services, and any log files your applications generate.

A scheduled CloudWatch event is used to trigger the Step Functions state machine.  The trigger is time based and when first deployed is set to run every day at 00:15.  The trigger time is configurable in the [variables.tf] file.

### Simple Storage Service (S3)
Amazon S3 is object storage built to store and retrieve any amount of data from anywhere on the Internet. It’s a simple storage service that offers an extremely durable, highly available, and infinitely scalable data storage infrastructure at very low costs.

By default the credential tracker creates a private (un-encrypted) bucket into which the credential reports and the results from executing the Athena queries are stored.  The bucket has 2 prefix paths.  One prefix is for the credential report and the other is for the results of running the various Athena queries specified.

If encryption is required it can be added to the bucket and Athena queries, however has not been fully implemented.

The Credentials Tracker creates a bucket per account.  In a multi-account set-up where there is a centralised security account these buckets should be copied/replicated into the central account.  This *is not* implemented as part of the Credentials Tracker.

### Lambda
AWS Lambda lets you run code without provisioning or managing servers. You pay only for the compute time you consume - there is no charge when your code is not running. With Lambda, you can run code for virtually any type of application or backend service - all with zero administration.

The credentials tracker deploys 12 lambda functions.

#### [Generate Report]
The Generate Report Lambda function calls the IAM service to request a new credentials report.

#### [Download Report]
The Download Report Lambda function calls the IAM service to download the credential report after it has been successfully generated.

#### [Initialise Report]
The Initialise Report Lambda uses 2 named queries deployed to Athena by the terraform script to create the Credentials report table in the Athena database and load the data into the table for querying.

#### [Generate Findings]
The Generate Findings Lambda function takes a parameter of the named query to be executed and return the query execution ID for the query running in Athena.  The query executed extracts a list of users for whom the credentials in the account fail to meet the criteria defined. The credentials criteria is set in the [variables.tf] file.

##### Generate Access Key Rotation Findings
The Generate Access Key Rotation Findings Lambda function calls the [ak-rotation-period] named query.

##### Generate Access Key Usage Findings
The Generate Access Key Usage Findings calls the [ak-usage-period] named query.

##### Generate Certificate Rotation Findings
The Generate Certificate Rotation Findings calls the [cert-rotation-period] named query.

##### Generate Credentials Usage Findings
The Generate Credentials Usage Findings calls the [cred-usage-period] named query.

#### [Retrieve Users to Remediate]
The Retrieve Users to Remediate Lambda function takes the query execution ID as an input from the state object that is passed by the Step Functions state machine and uses this to call the Athena get query result API.  This returns the list of users that were identified in the relevant Generate Findings step.

#### Remediate Findings
Due to the specific nature of the remediation steps required for each finding the Remediate Lambda functions have a function defined per finding.  Each of the functions below takes specific action to remediate the relevant finding.

##### [Remediate Access Key Rotation Findings]
The Remediate Access Key Rotation Findings Lambda function disables the access key that falls outside the specified rotation period.  The Access Key rotation period can be set in the [variables.tf] file.

##### [Remediate Access Key Usage Findings]
The Remediate Access Key Usage Findings Lambda function disables the access key whose time since last use falls outside the specified period.  The Access Key usage period can be set in the [variables.tf] file.

##### [Remediate Certificate Rotation Findings]
The Remediate Certificate Rotation Findings Lambda function disables the certificate whose time since last updated falls outside the specified period.  The signing certificate rotation period can be set in the [variables.tf] file.

##### [Remediate Credentials Usage Findings]
The Remediate Credentials Usage Findings Lambda function deletes the login profile of the user whose time since last usage falls outside the specified period.  The credentials usage period can be set in the [variables.tf] file.

### Athena
Amazon Athena is an interactive query service that makes it easy to analyse data in Amazon S3 using standard SQL. Athena is serverless, so there is no infrastructure to manage, and you pay only for the queries that you run.

In order to query the credential report in S3 an Athena database is created and the following named queries are deployed to Athena.

⋅⋅⋅ [create table]

⋅⋅⋅ [load partitions]

⋅⋅⋅ [ak-rotation-period]

⋅⋅⋅ [ak-usage-period]

⋅⋅⋅ [cert-rotation-period]

⋅⋅⋅ [cred-usage-period]

### Step Functions
Step Functions provides a reliable way to coordinate components and step through the functions of your application.  For the credentials tracker the state machine moves through 5 specific states.

**1. Generate Report**

During this step Step Functions calls the generate-report Lambda function which requests a new report be generated by the IAM service.

**2. Download Report**

During this step Step Functions calls the download-report Lambda function which downloads the latest generated report and places it into S3.  

**3. Initialise Table**

During this step Step Functions calls the initialise-report Lambda function which creates a table in Athena and loads the data partitions to make the data queryable in the Generate Findings step.

**4. Generate Findings**

During this step Step Functions calls the generate-findings Lambda function followed by the retrieve-users-to-remediate function.  The generate findings lambda function is parameterised so when it is deployed through Terraform it creates a function per finding.  A parameter is used to define which named Athena query needs to be executed to retrieve the correct users from the query result in the retrieve-users-to-remediate lambda.

⋅⋅⋅ [generate-findings]

**5. Remediate Findings**

During this step Step Functions calls the remediate-findings Lambda function related to the specific finding it needs to remediate.

⋅⋅⋅ [remediate-findings_ak-rotation]

⋅⋅⋅ [remediate-findings_ak-usage]

⋅⋅⋅ [remediate-findings_cert-rotation]

⋅⋅⋅ [remediate-findings_cred-usage]

## How to deploy
### Independently
In the root folder of the Credentials Tracker run "terraform init" and terraform apply.  The run will ask for the following variables to be set.

 - AWS Account Number in the form aws-account-number = "##########"

### As a module
To run as a module add the following snippet to a .tf file in the initialised folder for your script.

```terraform
module "credentials_tracker" {
  source = "[path to module]"
  aws-account-number = "[AWS account number]"
}
```

## How to run
### Time based execution
Once deployed the credential tracker will execute once per day at the time specified in the variable credentials-tracker-schedule variable.

```terraform
variable "credentials-tracker-schedule" {
  description = "The defined schedule for the cloudwatch alarm to trigger"
  default = "cron(15 12 * * ? *)"
}
```

### Manual Execution
**Note:** If running manually you will notice that a new Credential Report is not created for every request.  A new report can be generated every 4 hours.  If a new credential report is not created the step functions state object will inform you of this and provide the time of the last generated report that will be referenced for the manual run.

To start the credential report manually assume the credential report role or add the credential report permissions permissions policy and assume role policy to your user, group or role.  This might require some additional configuration if you are not set up to assume roles.  Refer to the AWS documentation on assuming IAM roles if this is the case.

From the Step Functions console or from the CLI start and execution of the credentials-tracker state machine.

[execution permissions policy]: /policies/lambda-execution.json.tpl
[assume role policy]: aws-credential-tracker/policies/lambda-trust.json
[arch-image]: /images/credential-tracker.png
[variables.tf]: /variables.tf
[generate-report]: /lambdas/generate-report/generate-report.py
[generate-findings]: /lambdas/generate-findings/generate-findings.py
[remediate-findings_ak-rotation]: /lambdas/remediate-findings_ak-rotation/remediate-findings_ak-rotation.py
[remediate-findings_ak-usage]: /lambdas/remediate-findings_ak-usage/remediate-findings_ak-usage.py
[remediate-findings_cert-rotation]: /lambdas/remediate-findings_cert-rotation/remediate-findings_cert-rotation.py
[remediate-findings_cred-usage]: /lambdas/remediate-findings_cred-usage/remediate-findings_cred-usage.py
[create table]: /athena/tables/credentials-report.hql.tpl
[load partitions]: /athena/tables/partition-update.hql.tpl
[ak-rotation-period]: /athena/queries/ak-rotation-period.hql.tpl
[ak-usage-period]: /athena/queries/ak-usage-period.hql.tpl
[cert-rotation-period]: /athena/queries/cert-rotation-period.hql.tpl
[cred-usage-period]: /athena/queries/cred-usage-period.hql.tpl
[Generate Report]: /lambdas/generate-report/generate-report.py
[Download Report]: /lambdas/download-report/download-report.py
[Initialise Report]: /lambdas/initialise-report/initialise-report.py
[Generate Findings]: /lambdas/generate-findings/generate-findings.py
[Retrieve Users to Remediate]: /lambdas/retrieve-users-to-remediate/retrieve-users-to-remediate.py
[Remediate Access Key Rotation Findings]: /lambdas/remediate-findings_ak-rotation/remediate-findings_ak-rotation.py
[Remediate Access Key Usage Findings]: /lambdas/remediate-findings_ak-usage/remediate-findings_ak-usage.py
[Remediate Certificate Rotation Findings]: /lambdas/remediate-findings_cert-rotation/remediate-findings_cert-rotation.py
[Remediate Credentials Usage Findings]: /lambdas/remediate-findings_cred-usage/remediate-findings_cred-usage.py
